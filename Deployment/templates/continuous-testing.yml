parameters:
  - name: AzureSubscription
    type: string

steps:
  - task: DownloadBuildArtifacts@0
    displayName: "Download Terraform Artifact"
    inputs:
      buildType: 'current'
      downloadType: 'single'
      artifactName: 'terraformartifact'
      downloadPath: '$(Build.SourcesDirectory)'

  - task: DownloadBuildArtifacts@0
    displayName: "Download Functional test Artifact"
    inputs:
      buildType: 'current'
      downloadType: 'single'
      artifactName: 'functionaltests'
      downloadPath: '$(Build.SourcesDirectory)'

  - task: FileTransform@2
    displayName: "File Transform: functionaltests"
    inputs:
       folderPath: '$(Build.SourcesDirectory)/functionaltests/'
       xmlTransformationRules:
       jsonTargetFiles: '**/appsettings.json'

  - task: UseDotNet@2
    displayName: 'Use .NET 8.0.x sdk'
    inputs:
      packageType: sdk
      version: 8.0.x

  - task: DotNetCoreCLI@2
    displayName: "Run Functional tests"
    inputs:
      command: "test"
      projects: |
          **/*FunctionalTest*.dll
          !**/*TestAdapter.dll
          !**/obj/**
      testRunTitle: "$(Environment)-AutomationTests"
      workingDirectory: '$(Build.SourcesDirectory)/functionaltests'
      arguments: >
        --logger "console;verbosity=detailed"
        --logger "trx;LogFileName=$(Build.ArtifactStagingDirectory)/TestResults/FunctionalTestResults.trx"
        --results-directory $(Build.ArtifactStagingDirectory)/TestResults